{% extends "base.html" %}

{% block title %}Clip Voice Sample - EchoMancer{% endblock %}

{% block content %}
<div class="container mx-auto px-4 md:px-8 py-8">
    <div class="max-w-5xl mx-auto space-y-6">
        <a href="{{ url_for('web.voice_selection') }}" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all h-9 px-4 py-2 hover:bg-accent hover:text-accent-foreground">
            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Back to Search
        </a>

        <div class="space-y-2">
            <h1>Clip Voice Sample</h1>
            <p class="text-muted-foreground">
                Select a portion of the {% if audio_url %}audio{% else %}video{% endif %} to use as your voice sample
            </p>
        </div>

        <!-- YouTube Embed or Audio Player -->
        <div class="bg-card border-border overflow-hidden rounded-xl border">
            <div class="p-0">
                <div class="aspect-video bg-muted flex items-center justify-center">
                    {% if audio_url or video_id == 'uploaded-audio' %}
                    <!-- Audio player for uploaded files -->
                    <div class="w-full h-full flex flex-col items-center justify-center p-8 space-y-4">
                        <div class="w-20 h-20 rounded-full bg-primary/10 flex items-center justify-center">
                            <svg class="w-10 h-10 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="text-center space-y-2">
                            <h3 class="text-lg font-semibold">{{ video_title }}</h3>
                            <p class="text-sm text-muted-foreground">Uploaded Audio Sample</p>
                        </div>
                        {% if audio_url %}
                        <audio controls src="{{ audio_url }}" class="w-full max-w-md">
                            Your browser does not support the audio element.
                        </audio>
                        {% endif %}
                    </div>
                    {% else %}
                    <!-- YouTube embed -->
                    <iframe
                        width="100%"
                        height="100%"
                        src="https://www.youtube.com/embed/{{ video_id }}?enablejsapi=1"
                        title="{{ video_title }}"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen
                        class="w-full h-full">
                    </iframe>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Clipping Controls -->
        <form method="POST" action="{{ url_for('web.create_job') }}" id="clip-form">
            <input type="hidden" name="video_id" value="{% if not audio_url %}{{ video_id }}{% endif %}">
            <input type="hidden" name="audio_sample_url" value="{{ audio_url or '' }}">
            <input type="hidden" name="video_title" value="{{ video_title }}">

            <div class="bg-card border-border rounded-xl border">
                <div class="p-6 space-y-2">
                    <h3 class="font-semibold">Voice Clip Selection</h3>
                </div>
                <div class="p-6 pt-0 space-y-8">
                    <!-- Dual Range Slider -->
                    <div class="space-y-6">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-muted-foreground">Start: <span id="start-display">0:00</span></span>
                                <span class="text-muted-foreground">End: <span id="end-display">1:00</span></span>
                            </div>

                            <div class="relative py-4">
                                <input type="range" name="start_time" id="start-slider" min="0" max="300" value="0" step="1" class="w-full" oninput="updateTimeDisplays()">
                                <input type="range" name="end_time" id="end-slider" min="0" max="300" value="60" step="1" class="w-full" oninput="updateTimeDisplays()">
                            </div>

                            <div class="flex items-center justify-between text-xs text-muted-foreground">
                                <span>0:00</span>
                                <span>5:00</span>
                            </div>
                        </div>

                        <!-- Time Inputs -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-3">
                                <label class="text-sm font-medium">Start Time</label>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1">
                                        <input type="number" min="0" max="5" value="0" id="start-min" class="flex h-9 w-full rounded-md border px-3 py-1 text-base bg-input-background text-center" oninput="updateSliderFromInputs()">
                                        <p class="text-xs text-muted-foreground text-center mt-1">Minutes</p>
                                    </div>
                                    <span class="text-2xl text-muted-foreground">:</span>
                                    <div class="flex-1">
                                        <input type="number" min="0" max="59" value="00" id="start-sec" class="flex h-9 w-full rounded-md border px-3 py-1 text-base bg-input-background text-center" oninput="updateSliderFromInputs()">
                                        <p class="text-xs text-muted-foreground text-center mt-1">Seconds</p>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <label class="text-sm font-medium">End Time</label>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1">
                                        <input type="number" min="0" max="5" value="1" id="end-min" class="flex h-9 w-full rounded-md border px-3 py-1 text-base bg-input-background text-center" oninput="updateSliderFromInputs()">
                                        <p class="text-xs text-muted-foreground text-center mt-1">Minutes</p>
                                    </div>
                                    <span class="text-2xl text-muted-foreground">:</span>
                                    <div class="flex-1">
                                        <input type="number" min="0" max="59" value="00" id="end-sec" class="flex h-9 w-full rounded-md border px-3 py-1 text-base bg-input-background text-center" oninput="updateSliderFromInputs()">
                                        <p class="text-xs text-muted-foreground text-center mt-1">Seconds</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Clip Duration Info -->
                        <div class="bg-muted/50 p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="text-sm">Clip Duration:</span>
                                <span class="font-semibold" id="duration-display">1:00</span>
                            </div>
                        </div>

                        <!-- Preview Button -->
                        <button type="button" onclick="showToast('Preview: ' + document.getElementById('start-display').textContent + ' - ' + document.getElementById('end-display').textContent, 'info')" class="w-full inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all h-9 px-4 py-2 border bg-background text-foreground hover:bg-accent">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Preview Clip (<span id="preview-duration">1:00</span>)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Terms Agreement -->
            <div class="bg-card border-border rounded-xl border">
                <div class="p-6">
                    <div class="flex items-start gap-3">
                        <input type="checkbox" id="terms" name="agree_terms" required class="mt-1 w-4 h-4" onchange="document.getElementById('submit-btn').disabled = !this.checked">
                        <div class="space-y-1">
                            <label for="terms" class="text-sm leading-relaxed cursor-pointer">
                                I confirm that I have the right to use this voice sample and agree to echomancer's
                                <a href="#" class="text-primary hover:underline">Terms of Service</a> and
                                <a href="#" class="text-primary hover:underline">Voice Usage Policy</a>.
                                I understand that I am responsible for ensuring I have appropriate permissions for voice cloning.
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4">
                <a href="{{ url_for('web.voice_selection') }}" class="flex-1 inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all h-9 px-4 py-2 border bg-background text-foreground hover:bg-accent">
                    Cancel
                </a>
                <button type="submit" id="submit-btn" disabled class="flex-1 inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all h-9 px-4 py-2 bg-green-600 hover:bg-green-700 text-white glow-green disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Use This Clip
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return mins + ':' + secs.toString().padStart(2, '0');
}

function updateTimeDisplays() {
    const startTime = parseInt(document.getElementById('start-slider').value);
    const endTime = parseInt(document.getElementById('end-slider').value);

    document.getElementById('start-display').textContent = formatTime(startTime);
    document.getElementById('end-display').textContent = formatTime(endTime);
    document.getElementById('duration-display').textContent = formatTime(endTime - startTime);
    document.getElementById('preview-duration').textContent = formatTime(endTime - startTime);

    document.getElementById('start-min').value = Math.floor(startTime / 60);
    document.getElementById('start-sec').value = (startTime % 60).toString().padStart(2, '0');
    document.getElementById('end-min').value = Math.floor(endTime / 60);
    document.getElementById('end-sec').value = (endTime % 60).toString().padStart(2, '0');
}

function updateSliderFromInputs() {
    const startMin = parseInt(document.getElementById('start-min').value) || 0;
    const startSec = parseInt(document.getElementById('start-sec').value) || 0;
    const endMin = parseInt(document.getElementById('end-min').value) || 0;
    const endSec = parseInt(document.getElementById('end-sec').value) || 0;

    const startTime = Math.min(startMin * 60 + startSec, 300);
    const endTime = Math.min(endMin * 60 + endSec, 300);

    document.getElementById('start-slider').value = startTime;
    document.getElementById('end-slider').value = endTime;

    updateTimeDisplays();
}

// Initialize
updateTimeDisplays();
</script>
{% endblock %}
